<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whiskey Challenge Admin</title>

    <!-- Firebase CDN Scripts with correct module imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCqZMaGpJGf5veYgTXmytg1bLerva-of0U",
            authDomain: "whiskeywiz2.firebaseapp.com",
            projectId: "whiskeywiz2",
            storageBucket: "whiskeywiz2.appspot.com",
            messagingSenderId: "555320797929",
            appId: "1:555320797929:web:0d4b062d7f2ab330fc1e78",
            measurementId: "G-SK0TJJEPF5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', async function () {
            const quarterForm = document.getElementById('quarter-form');
            const samplesContainer = document.getElementById('samples-container');
            const quarterNameInput = document.getElementById('quarter-name');
            const quartersList = document.getElementById('quarters-list');
            const generateButton = document.getElementById('generate-button');

            // Function to create sample answer input fields
            function createSampleAnswerInputs(sampleIndex) {
                const sampleDiv = document.createElement('div');
                sampleDiv.classList.add('sample-answer');

                const mashbillLabel = document.createElement('label');
                mashbillLabel.innerText = `Sample ${sampleIndex + 1} - Mashbill: `;
                const mashbillInput = document.createElement('input');
                mashbillInput.type = 'text';

                const proofLabel = document.createElement('label');
                proofLabel.innerText = 'Proof: ';
                const proofInput = document.createElement('input');
                proofInput.type = 'number';

                const ageLabel = document.createElement('label');
                ageLabel.innerText = 'Age: ';
                const ageInput = document.createElement('input');
                ageInput.type = 'number';

                // Append elements stacked
                sampleDiv.appendChild(mashbillLabel);
                sampleDiv.appendChild(mashbillInput);
                sampleDiv.appendChild(document.createElement('br'));

                sampleDiv.appendChild(proofLabel);
                sampleDiv.appendChild(proofInput);
                sampleDiv.appendChild(document.createElement('br'));

                sampleDiv.appendChild(ageLabel);
                sampleDiv.appendChild(ageInput);
                sampleDiv.appendChild(document.createElement('br'));

                return sampleDiv;
            }

            // Add sample input fields for answers
            for (let i = 0; i < 4; i++) {
                samplesContainer.appendChild(createSampleAnswerInputs(i));
            }

            // Submit form to save quarter
            quarterForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const quarterName = quarterNameInput.value.trim();
                const samples = [];

                // Gather sample answers
                document.querySelectorAll('.sample-answer').forEach((sampleDiv) => {
                    samples.push({
                        mashbill: sampleDiv.querySelector('input[type="text"]').value,
                        proof: sampleDiv.querySelector('input[type="number"]').value,
                        age: sampleDiv.querySelector('input[type="number"]').value
                    });
                });

                // Save quarter and sample answers to Firestore
                await setDoc(doc(db, 'quarters', quarterName), {
                    name: quarterName,
                    samples: samples
                });

                alert('Quarter saved successfully!');
                quarterForm.reset();
                loadQuarterOptions();
            });

            // Load quarters into dropdown for HTML generation
            async function loadQuarterOptions() {
                quartersList.innerHTML = ''; // Clear existing options
                const quartersSnapshot = await getDocs(collection(db, 'quarters'));
                quartersSnapshot.forEach(doc => {
                    const quarterData = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id; // Quarter ID
                    option.innerText = quarterData.name;
                    quartersList.appendChild(option);
                });
            }

            // Generate HTML for the selected quarter and trigger download
            generateButton.addEventListener('click', async () => {
                const selectedQuarterId = quartersList.value;
                if (!selectedQuarterId) {
                    alert('Please select a quarter.');
                    return;
                }

                const quarterDoc = await getDoc(doc(db, 'quarters', selectedQuarterId));
                if (quarterDoc.exists()) {
                    const quarterData = quarterDoc.data();
                    const generatedHtml = createPlayerHTML(quarterData);
                    downloadHTML(generatedHtml, `${selectedQuarterId}.html`);
                } else {
                    alert('Quarter data not found.');
                }
            });

            // Function to create the HTML content for the player page
            function createPlayerHTML(quarterData) {
                return `
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>${quarterData.name} - Whiskey Challenge</title>
                        <link rel="stylesheet" href="styles.css">
                    </head>
                    <body>
                        <h1>Whiskey Challenge - ${quarterData.name}</h1>
                        <div id="game-content" style="display: flex;">
                            ${quarterData.samples.map((sample, index) => `
                                <div class="sample" style="flex: 1; padding: 10px; border: 1px solid #ccc;">
                                    <h3>Sample ${index + 1}</h3>
                                    <p>Mashbill: ${sample.mashbill}</p>
                                    <p>Proof: ${sample.proof}</p>
                                    <p>Age: ${sample.age}</p>
                                </div>`).join('')}
                        </div>
                    </body>
                    </html>
                `;
            }

            // Trigger the download of the generated HTML file
            function downloadHTML(htmlContent, fileName) {
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                link.click();
            }

            // Load quarters on page load
            loadQuarterOptions();
        });
    </script>

    <style>
        /* Basic styles */
        .sample-answer {
            margin-bottom: 10px;
        }

        /* Style for 4 column layout */
        #samples-container {
            display: flex;
            gap: 10px;
        }

        .sample-answer {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
        }

        .controls {
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <h1>Admin - Whiskey Challenge</h1>

    <!-- Quarterly Creation Tool -->
    <form id="quarter-form">
        <label for="quarter-name">Quarter Name:</label>
        <select id="quarter-name" required>
            <option value="">Select Quarter</option>
            <option value="January-2024">January 2024</option>
            <option value="March-2024">March 2024</option>
            <option value="June-2024">June 2024</option>
            <option value="September-2024">September 2024</option>
            <option value="December-2024">December 2024</option>
            <!-- Add more years dynamically here -->
        </select>

        <h3>Set Answers for 4 Samples (Side by Side):</h3>
        <div id="samples-container">
            <!-- Sample answer inputs will be dynamically added here -->
        </div>

        <button type="submit">Save Quarter</button>
    </form>

    <!-- Player HTML Generation Tool -->
    <div class="controls">
        <h3>Generate Player HTML</h3>
        <label for="quarters-list">Select Quarter:</label>
        <select id="quarters-list">
            <!-- Quarters will be dynamically loaded here -->
        </select>
        <button id="generate-button">Generate Player HTML</button>
    </div>
</body>

</html>
