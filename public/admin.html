<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whiskey Challenge Admin</title>
    
    <!-- Firebase and Handlebars CDN Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-analytics.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getStorage } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";
        import { getFunctions } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-functions.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCqZMaGpJGf5veYgTXmytg1bLerva-of0U",
            authDomain: "whiskeywiz2.firebaseapp.com",
            databaseURL: "https://whiskeywiz2-default-rtdb.firebaseio.com",
            projectId: "whiskeywiz2",
            storageBucket: "whiskeywiz2.appspot.com",
            messagingSenderId: "555320797929",
            appId: "1:555320797929:web:0d4b062d7f2ab330fc1e78",
            measurementId: "G-SK0TJJEPF5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.min.js"></script>

    <link rel="stylesheet" href="admin.css">
</head>

<body>
    <h1>Admin - Whiskey Challenge</h1>
    <h2>Create or Edit Quarters</h2>

    <form id="quarter-form">
        <!-- Select month/year for quarter -->
        <label for="quarter-name">Select Quarter:</label>
        <select id="quarter-name">
            <option value="Q1-2024">January 2024</option>
            <option value="Q2-2024">April 2024</option>
            <option value="Q3-2024">July 2024</option>
            <option value="Q4-2024">October 2024</option>
        </select>

        <h3>Set Answers for 4 Samples:</h3>

        <div id="samples-container">
            <!-- Sample answer inputs will be dynamically added here -->
        </div>

        <button type="submit">Save Quarter</button>
    </form>

    <div id="quarters-list"></div>

    <!-- Handlebars Template for generating Player HTML -->
    <script id="player-template" type="text/x-handlebars-template">
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>{{quarterName}} - Whiskey Challenge</title>
            <link rel="stylesheet" href="styles.css">
        </head>
        <body>
            <h1>{{quarterName}} - Whiskey Challenge</h1>
            <div id="game-container">
                {{#each samples}}
                <div class="sample">
                    <label>Select Mashbill for Sample {{@index}}:</label>
                    <select>
                        <option value="Bourbon">Bourbon</option>
                        <option value="Rye">Rye</option>
                        <option value="Wheat">Wheat</option>
                        <option value="Single Malt">Single Malt</option>
                        <option value="Blend">Blend</option>
                        <option value="Specialty">Specialty</option>
                    </select>

                    <label>Guess Proof:</label>
                    <input type="range" min="80" max="130" value="{{proof}}">
                    <span>{{proof}}</span>

                    <label>Guess Age:</label>
                    <input type="range" min="1" max="10" value="{{age}}">
                    <span>{{age}}</span>
                </div>
                {{/each}}
            </div>
        </body>
        </html>
    </script>

    <script>
        const quarterForm = document.getElementById('quarter-form');
        const samplesContainer = document.getElementById('samples-container');
        const quartersList = document.getElementById('quarters-list');
        const quarterNameInput = document.getElementById('quarter-name');
        const playerTemplateSource = document.getElementById('player-template').innerHTML;
        const playerTemplate = Handlebars.compile(playerTemplateSource);

        function createSampleAnswerInputs(sampleIndex) {
            const sampleDiv = document.createElement('div');
            sampleDiv.classList.add('sample-answer');

            const mashbillLabel = document.createElement('label');
            mashbillLabel.innerText = `Sample ${sampleIndex + 1} - Mashbill: `;
            const mashbillInput = document.createElement('input');
            mashbillInput.type = 'text';

            const proofLabel = document.createElement('label');
            proofLabel.innerText = 'Proof: ';
            const proofInput = document.createElement('input');
            proofInput.type = 'number';

            const ageLabel = document.createElement('label');
            ageLabel.innerText = 'Age: ';
            const ageInput = document.createElement('input');
            ageInput.type = 'number';

            sampleDiv.appendChild(mashbillLabel);
            sampleDiv.appendChild(mashbillInput);
            sampleDiv.appendChild(document.createElement('br'));

            sampleDiv.appendChild(proofLabel);
            sampleDiv.appendChild(proofInput);
            sampleDiv.appendChild(document.createElement('br'));

            sampleDiv.appendChild(ageLabel);
            sampleDiv.appendChild(ageInput);
            sampleDiv.appendChild(document.createElement('br'));

            return sampleDiv;
        }

        for (let i = 0; i < 4; i++) {
            samplesContainer.appendChild(createSampleAnswerInputs(i));
        }

        quarterForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const quarterName = quarterNameInput.value.trim();
            const samples = [];

            document.querySelectorAll('.sample-answer').forEach((sampleDiv) => {
                samples.push({
                    mashbill: sampleDiv.querySelector('input[type="text"]').value,
                    proof: sampleDiv.querySelector('input[type="number"]').value,
                    age: sampleDiv.querySelector('input[type="number"]').value
                });
            });

            await setDoc(doc(db, 'quarters', quarterName), {
                name: quarterName,
                samples: samples
            });

            alert('Quarter saved successfully!');
            quarterForm.reset();
            fetchQuarters(); // Refresh quarters list

            const playerHTML = playerTemplate({ quarterName: quarterName, samples: samples });
            const blob = new Blob([playerHTML], { type: 'text/html' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${quarterName}.html`;
            link.click();
        });

        async function fetchQuarters() {
            const snapshot = await getDocs(collection(db, 'quarters'));
            quartersList.innerHTML = '';
            snapshot.forEach((doc) => {
                const quarterData = doc.data();
                const quarterDiv = document.createElement('div');
                quarterDiv.innerHTML = `<strong>${quarterData.name}</strong>
                                        <button onclick="editQuarter('${doc.id}')">Edit</button>`;
                quartersList.appendChild(quarterDiv);
            });
        }

        window.editQuarter = async function(quarterId) {
            const docSnap = await getDoc(doc(db, 'quarters', quarterId));
            if (docSnap.exists()) {
                const quarterData = docSnap.data();
                quarterNameInput.value = quarterData.name;

                quarterData.samples.forEach((sample, index) => {
                    const sampleDiv = document.querySelectorAll('.sample-answer')[index];
                    sampleDiv.querySelector('input[type="text"]').value = sample.mashbill;
                    sampleDiv.querySelector('input[type="number"]').value = sample.proof;
                    sampleDiv.querySelector('input[type="number"]').value = sample.age;
                });
            }
        };

        fetchQuarters();
    </script>

</body>

</html>
