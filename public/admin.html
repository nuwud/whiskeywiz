<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whiskey Challenge Admin</title>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, deleteObject } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCqZMaGpJGf5veYgTXmytg1bLerva-of0U",
            authDomain: "whiskeywiz2.firebaseapp.com",
            projectId: "whiskeywiz2",
            storageBucket: "whiskeywiz2.appspot.com",
            messagingSenderId: "555320797929",
            appId: "1:555320797929:web:0d4b062d7f2ab330fc1e78",
            measurementId: "G-SK0TJJEPF5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        document.addEventListener('DOMContentLoaded', async function () {
            const quartersContainer = document.getElementById('quarters-container');
            const generateButton = document.getElementById('generate-button');
            const deleteButton = document.getElementById('delete-button');
            const quartersList = document.getElementById('quarters-list');

            // Load quarters into dropdown
            async function loadQuarterOptions() {
                const quartersSnapshot = await getDocs(collection(db, 'quarters'));
                quartersSnapshot.forEach(doc => {
                    const quarterData = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id; // Quarter ID
                    option.innerText = quarterData.name;
                    quartersList.appendChild(option);
                });
            }

            // Generate HTML for the selected quarter
            generateButton.addEventListener('click', async () => {
                const selectedQuarterId = quartersList.value;
                if (!selectedQuarterId) {
                    alert('Please select a quarter.');
                    return;
                }

                const quarterDoc = await getDoc(doc(db, 'quarters', selectedQuarterId));
                if (quarterDoc.exists()) {
                    const quarterData = quarterDoc.data();
                    const generatedHtml = createPlayerHTML(quarterData);
                    await uploadGeneratedHTML(selectedQuarterId, generatedHtml);
                    alert('Player HTML generated and uploaded.');
                } else {
                    alert('Quarter data not found.');
                }
            });

            // Function to create the HTML content for the player page
            function createPlayerHTML(quarterData) {
                return `
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>${quarterData.name} - Whiskey Challenge</title>
                        <link rel="stylesheet" href="styles.css">
                    </head>
                    <body>
                        <h1>Whiskey Challenge - ${quarterData.name}</h1>
                        <div id="game-content">
                            ${quarterData.samples.map((sample, index) => `
                                <div class="sample">
                                    <h3>Sample ${index + 1}</h3>
                                    <p>Mashbill: ${sample.mashbill}</p>
                                    <p>Proof: ${sample.proof}</p>
                                    <p>Age: ${sample.age}</p>
                                </div>`).join('')}
                        </div>
                    </body>
                    </html>
                `;
            }

            // Upload the generated HTML to Firebase Storage
            async function uploadGeneratedHTML(quarterId, htmlContent) {
                const htmlRef = ref(storage, `${quarterId}.html`);
                await uploadString(htmlRef, htmlContent, 'raw', { contentType: 'text/html' });
            }

            // Delete the generated HTML file from Firebase Storage
            deleteButton.addEventListener('click', async () => {
                const selectedQuarterId = quartersList.value;
                if (!selectedQuarterId) {
                    alert('Please select a quarter to delete.');
                    return;
                }

                const htmlRef = ref(storage, `${selectedQuarterId}.html`);
                try {
                    await deleteObject(htmlRef);
                    alert('Player HTML deleted.');
                } catch (error) {
                    console.error('Error deleting file:', error);
                    alert('Failed to delete the player HTML.');
                }
            });

            // Load quarters on page load
            loadQuarterOptions();
        });
    </script>

    <style>
        /* Style for better layout */
        .controls { margin-top: 10px; }
    </style>
</head>

<body>
    <h1>Admin - Whiskey Challenge</h1>

    <label for="quarters-list">Select Quarter:</label>
    <select id="quarters-list">
        <!-- Quarters will be dynamically loaded here -->
    </select>

    <div class="controls">
        <button id="generate-button">Generate Player HTML</button>
        <button id="delete-button">Delete Player HTML</button>
    </div>
</body>

</html>
